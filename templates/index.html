<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SugarRush!</title>
  <script src="/static/3Dmol/3Dmol-min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .header img { height: 60px; }
    #controls { margin-bottom: 20px; }
    .viewer-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    #viewer {
      width: 500px;
      height: 400px;
      border: 1px solid #ccc;
      position: relative;   /* ensure canvas stays inside */
      overflow: hidden;     /* prevent canvas spill */
    }

    #mol2d {
      width: 500px;
      height: 400px;
      border: 1px solid #ccc;
      object-fit: contain;
    }
    table { border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #888; padding: 6px 10px; text-align: center; }
    th { background-color: #f0f0f0; }
    .highlight { background-color: yellow; cursor: pointer; }
    @media (prefers-color-scheme: dark) {
      body { background-color: #121212; color: #e0e0e0; }
      th { background-color: #333; }
      td { color: #ddd; }
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="/static/logo.png" alt="Logo">
    <h2>SugarRush!</h2>
  </div>

  <div id="controls">
    <input type="text" id="smiles" placeholder="Enter SMILES" size="50", value="C[C@@H]1O[C@@H](O)[C@@H](O)[C@H](O)[C@@H]1O">
    <button onclick="predict()">Predict NMR</button>
  </div>

  <div class="viewer-container">
    <div id="viewer"></div>
    <img id="mol2d" alt="2D Molecule">
  </div>

  <div class="output">
    <h3>Predicted Shifts</h3>
    <div id="tables"></div>
  </div>

<script>
let viewer; // global viewer reference

async function predict() {
    const smiles = document.getElementById("smiles").value;
    if (!smiles) { alert("Please enter a SMILES string"); return; }

    // Prediction
    const resp = await fetch("/predict", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({smiles})
    });
    const data = await resp.json();

    // Collect atom indices
    const carbonIndices = data.predicted_13C.map(d => d.atom_index);

    // Build combined table
    let tableHtml = "<table><tr><th></th>";
    carbonIndices.forEach(idx => { tableHtml += `<th>${idx}</th>`; });
    tableHtml += "</tr>";

    // Row: 13C
    tableHtml += "<tr><td><b>13C</b></td>";
    carbonIndices.forEach(idx => {
        const val = data.predicted_13C.find(d => d.atom_index === idx)?.shift ?? null;
        tableHtml += `<td class="clickable" data-atom="${idx}">${val !== null ? val.toFixed(2) : "—"}</td>`;
    });
    tableHtml += "</tr>";

    // Row: 1H
    tableHtml += "<tr><td><b>1H</b></td>";
    carbonIndices.forEach(idx => {
        const val = data.predicted_1H.find(d => d.atom_index === idx)?.shift ?? null;
        tableHtml += `<td class="clickable" data-atom="${idx}">${val !== null ? val.toFixed(2) : "—"}</td>`;
    });
    tableHtml += "</tr>";

    tableHtml += "</table>";
    document.getElementById("tables").innerHTML = tableHtml;

    // 3D structure
    const sdfResp = await fetch("/mol3d", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({smiles})
    });
    const sdf = await sdfResp.text();

    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const bgColor = prefersDark ? "#121212" : "white";

    const element = document.getElementById("viewer");
    element.innerHTML = "";
    viewer = $3Dmol.createViewer(element, { backgroundColor: bgColor });
    viewer.addModel(sdf, "sdf");
    viewer.setStyle({}, {stick: {radius:0.15}, sphere: {scale:0.3}});
    viewer.zoomTo();
    viewer.render();
    viewer.resize();   // <--- important fix

    // 2D image
    const imgResp = await fetch("/mol2d", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({smiles})
    });
    const imgBlob = await imgResp.blob();
    document.getElementById("mol2d").src = URL.createObjectURL(imgBlob);

    // Add click handlers for highlighting
    document.querySelectorAll(".clickable").forEach(cell => {
        cell.addEventListener("click", () => {
            const atomIndex = parseInt(cell.dataset.atom);
            highlightAtom(atomIndex);
        });
    });
}

function highlightAtom(atomIndex) {
    if (!viewer) return;
    viewer.setStyle({}, {stick: {radius:0.15}, sphere: {scale:0.3}});
    viewer.setStyle({serial: atomIndex+1}, {sphere: {color:"red", scale:0.5}, stick:{radius:0.2}});
    viewer.zoomTo({serial: atomIndex+1});
    viewer.render();
}
</script>
</body>
</html>
